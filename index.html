<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“š Ray çš„å­¸ç¿’ç ”ç©¶åº«</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans TC', -apple-system, sans-serif; }
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useMemo, useEffect, useRef } = React;

    const API_URL = "https://david86726.app.n8n.cloud/webhook/youtube-videos";
    const UPDATE_API_URL = "https://david86726.app.n8n.cloud/webhook/update-video";
    const DELETE_API_URL = "https://david86726.app.n8n.cloud/webhook/delete-video";

    const categories = ["å…¨éƒ¨", "äº¤æ˜“", "AI è‡ªå‹•åŒ–", "å•†æ¥­", "å¥èº«", "å…©æ€§", "äººç”Ÿ", "ç¾å­¸"];
    const editableCategories = ["äº¤æ˜“", "AI è‡ªå‹•åŒ–", "å•†æ¥­", "å¥èº«", "å…©æ€§", "äººç”Ÿ", "ç¾å­¸"];
    const statuses = ["å…¨éƒ¨", "å¾…çœ‹", "é€²è¡Œä¸­", "å·²å®Œæˆ"];

    function timeToSeconds(timeStr) {
      const parts = timeStr.split(':').map(Number);
      if (parts.length === 2) return parts[0] * 60 + parts[1];
      if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
      return 0;
    }

    function parseHighlights(text) {
      if (!text) return [];
      const lines = text.split('\n').filter(line => line.trim());
      return lines.map(line => {
        const match = line.match(/^(?:\d+\.\s*)?(\d+:\d+)(?:-(\d+:\d+))?\s*[-ï¼š]?\s*(.+)$/);
        if (match) {
          return {
            startTime: match[1],
            endTime: match[2] || null,
            description: match[3].trim().replace(/^[-ï¼š]\s*/, ''),
            startSeconds: timeToSeconds(match[1])
          };
        }
        return null;
      }).filter(Boolean);
    }

    function StarRating({ rating, onRate, size = "text-lg" }) {
      const [hoverRating, setHoverRating] = useState(0);
      return (
        <div className="flex gap-0.5">
          {[1, 2, 3, 4, 5].map(star => (
            <button
              key={star}
              onClick={() => onRate(star)}
              onMouseEnter={() => setHoverRating(star)}
              onMouseLeave={() => setHoverRating(0)}
              className={`${size} transition-colors ${
                (hoverRating || rating) >= star ? 'text-yellow-400' : 'text-neutral-600'
              } hover:scale-110`}
            >
              â˜…
            </button>
          ))}
        </div>
      );
    }

    function CategorySelector({ currentCategory, onCategoryChange, isUpdating }) {
      return (
        <div className="flex flex-wrap gap-2">
          {editableCategories.map(category => (
            <button
              key={category}
              onClick={() => onCategoryChange(category)}
              disabled={isUpdating}
              className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${
                currentCategory === category
                  ? "bg-amber-500/20 text-amber-400 border border-amber-500/30"
                  : "bg-neutral-800 text-neutral-400 hover:bg-neutral-700"
              } ${isUpdating ? 'opacity-50 cursor-not-allowed' : ''}`}
            >
              {category}
            </button>
          ))}
        </div>
      );
    }

    function StatusSelector({ currentStatus, onStatusChange }) {
      const statusOptions = ["å¾…çœ‹", "é€²è¡Œä¸­", "å·²å®Œæˆ"];
      return (
        <div className="flex gap-2">
          {statusOptions.map(status => (
            <button
              key={status}
              onClick={() => onStatusChange(status)}
              className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${
                currentStatus === status
                  ? status === "å¾…çœ‹" ? "bg-neutral-700 text-white" :
                    status === "é€²è¡Œä¸­" ? "bg-amber-500/20 text-amber-400 border border-amber-500/30" :
                    "bg-emerald-500/20 text-emerald-400 border border-emerald-500/30"
                  : "bg-neutral-800 text-neutral-400 hover:bg-neutral-700"
              }`}
            >
              {status}
            </button>
          ))}
        </div>
      );
    }

    function VideoModal({ video, onClose, onUpdate, onDelete }) {
      const [rating, setRating] = useState(video.rating || 0);
      const [status, setStatus] = useState(video.status || "å¾…çœ‹");
      const [category, setCategory] = useState(video.category || "");
      const [isUpdating, setIsUpdating] = useState(false);
      const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
      const [isDeleting, setIsDeleting] = useState(false);
      const [currentTime, setCurrentTime] = useState(0);
      const [shouldAutoplay, setShouldAutoplay] = useState(false);

      const getVideoId = (url) => {
        const match = url?.match(/[?&]v=([^&]+)/);
        return match ? match[1] : null;
      };

      const videoId = getVideoId(video.url);
      const highlights = parseHighlights(video.highlights);

      const seekTo = (seconds) => {
        setCurrentTime(seconds);
        setShouldAutoplay(true);
      };

      const youtubeUrl = videoId 
        ? `https://www.youtube.com/embed/${videoId}${currentTime > 0 ? `?start=${currentTime}` : ''}${shouldAutoplay ? (currentTime > 0 ? '&' : '?') + 'autoplay=1' : ''}`
        : '';

      const handleRatingChange = async (newRating) => {
        setRating(newRating);
        setIsUpdating(true);
        try {
          await fetch(UPDATE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pageId: video.id, rating: newRating, status, category })
          });
          onUpdate(video.id, { rating: newRating, status, category });
        } catch (err) {
          console.error('Error updating:', err);
        }
        setIsUpdating(false);
      };

      const handleStatusChange = async (newStatus) => {
        setStatus(newStatus);
        setIsUpdating(true);
        try {
          await fetch(UPDATE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pageId: video.id, rating, status: newStatus, category })
          });
          onUpdate(video.id, { rating, status: newStatus, category });
        } catch (err) {
          console.error('Error updating:', err);
        }
        setIsUpdating(false);
      };

      const handleCategoryChange = async (newCategory) => {
        setCategory(newCategory);
        setIsUpdating(true);
        try {
          await fetch(UPDATE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pageId: video.id, rating, status, category: newCategory })
          });
          onUpdate(video.id, { rating, status, category: newCategory });
        } catch (err) {
          console.error('Error updating:', err);
        }
        setIsUpdating(false);
      };

      const handleDelete = async () => {
        setIsDeleting(true);
        try {
          await fetch(DELETE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pageId: video.id })
          });
          onDelete(video.id);
          onClose();
        } catch (err) {
          console.error('Error deleting:', err);
          alert('åˆªé™¤å¤±æ•—');
        }
        setIsDeleting(false);
      };

      useEffect(() => {
        const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
        window.addEventListener('keydown', handleEsc);
        return () => window.removeEventListener('keydown', handleEsc);
      }, [onClose]);

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={onClose}>
          <div className="bg-neutral-900 rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto border border-neutral-800" onClick={e => e.stopPropagation()}>
            {videoId && (
              <div className="relative aspect-video">
                <iframe key={youtubeUrl} src={youtubeUrl} className="w-full h-full rounded-t-2xl" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowFullScreen />
                <div className="absolute bottom-3 left-3 bg-black/70 px-2 py-1 rounded text-xs text-white">
                  åˆ°ä»¥ä¸‹å¹³å°è§€çœ‹ï¼šã€€<span className="font-semibold">â–¶ YouTube</span>
                </div>
              </div>
            )}

            <div className="p-5 space-y-5">
              {highlights.length > 0 && (
                <div className="bg-neutral-800/50 rounded-xl p-4">
                  <h3 className="text-amber-400 font-medium mb-3">â­ ç²¾è¯ç‰‡æ®µï¼ˆé»æ“Šè·³è½‰ï¼‰</h3>
                  <div className="space-y-2">
                    {highlights.map((h, idx) => (
                      <button key={idx} onClick={() => seekTo(h.startSeconds)} className="w-full flex items-start gap-3 text-left hover:bg-neutral-700/50 rounded-lg p-2 transition-colors">
                        <span className="bg-amber-500/20 text-amber-400 px-2 py-1 rounded text-xs font-mono whitespace-nowrap">
                          {h.startTime}{h.endTime ? `-${h.endTime}` : ''}
                        </span>
                        <span className="text-neutral-300 text-sm">{h.description}</span>
                      </button>
                    ))}
                  </div>
                </div>
              )}

              <div className="flex flex-wrap justify-between items-center gap-4">
                <div>
                  <p className="text-neutral-500 text-xs mb-1">æˆ‘çš„è©•åˆ†</p>
                  <StarRating rating={rating} onRate={handleRatingChange} />
                </div>
                <div>
                  <p className="text-neutral-500 text-xs mb-1">è§€çœ‹ç‹€æ…‹</p>
                  <StatusSelector currentStatus={status} onStatusChange={handleStatusChange} />
                </div>
              </div>

              <div>
                <p className="text-neutral-500 text-xs mb-2">åˆ†é¡ {isUpdating && <span className="text-amber-400">ï¼ˆæ›´æ–°ä¸­...ï¼‰</span>}</p>
                <CategorySelector currentCategory={category} onCategoryChange={handleCategoryChange} isUpdating={isUpdating} />
              </div>

              {video.summary && (
                <div className="bg-neutral-800/50 rounded-xl p-4">
                  <h3 className="text-neutral-400 font-medium mb-2">ğŸ¤– AI æ‘˜è¦</h3>
                  <div className="text-neutral-300 text-sm whitespace-pre-line">{video.summary}</div>
                  {video.keyTakeaway && (
                    <div className="mt-3 pt-3 border-t border-neutral-700">
                      <p className="text-amber-400 text-sm">ğŸ’¡ {video.keyTakeaway}</p>
                    </div>
                  )}
                </div>
              )}

              <div className="flex gap-3 pt-2">
                <a href={video.url} target="_blank" rel="noopener noreferrer" className="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-3 rounded-xl text-center transition-colors">
                  â–¶ åœ¨ YouTube è§€çœ‹
                </a>
                <button onClick={() => setShowDeleteConfirm(true)} className="p-3 bg-neutral-800 hover:bg-neutral-700 rounded-xl transition-colors">ğŸ—‘ï¸</button>
                <button onClick={onClose} className="px-5 py-3 bg-neutral-800 hover:bg-neutral-700 rounded-xl transition-colors">é—œé–‰</button>
              </div>

              {showDeleteConfirm && (
                <div className="bg-red-900/30 border border-red-800 rounded-xl p-4 mt-4">
                  <p className="text-red-400 mb-3">ç¢ºå®šè¦åˆªé™¤é€™éƒ¨å½±ç‰‡å—ï¼Ÿ</p>
                  <div className="flex gap-3">
                    <button onClick={handleDelete} disabled={isDeleting} className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm disabled:opacity-50">
                      {isDeleting ? 'åˆªé™¤ä¸­...' : 'ç¢ºå®šåˆªé™¤'}
                    </button>
                    <button onClick={() => setShowDeleteConfirm(false)} className="px-4 py-2 bg-neutral-700 hover:bg-neutral-600 rounded-lg text-sm">å–æ¶ˆ</button>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    function VideoCard({ video, getThumbnail, onOpenModal }) {
      return (
        <div className="bg-neutral-900 rounded-xl overflow-hidden border border-neutral-800 hover:border-neutral-700 transition-all cursor-pointer group" onClick={() => onOpenModal(video)}>
          <div className="relative aspect-video bg-neutral-800">
            <img src={getThumbnail(video)} alt={video.title} className="w-full h-full object-cover" loading="lazy" />
            {video.priority && <span className="absolute top-2 right-2 bg-black/70 px-2 py-1 rounded text-xs">{video.priority}</span>}
          </div>
          <div className="p-4">
            <div className="flex items-center gap-2 text-xs text-neutral-500 mb-2">
              <span className="bg-neutral-800 px-2 py-0.5 rounded">{video.category || 'æœªåˆ†é¡'}</span>
              <span>Â·</span>
              <span>{video.status}</span>
            </div>
            <h3 className="font-medium text-white line-clamp-2 mb-2 group-hover:text-amber-400 transition-colors">{video.title}</h3>
            <p className="text-neutral-500 text-sm">{video.channel}</p>
            <div className="mt-3 pt-3 border-t border-neutral-800">
              <p className="text-neutral-400 text-xs line-clamp-2">{video.summary || 'å°šæœªæ•´ç†æ‘˜è¦'}</p>
            </div>
            <div className="flex items-center justify-between mt-3">
              <span className="text-neutral-400 text-sm">ğŸ“– æŸ¥çœ‹è©³æƒ…</span>
              <div className="w-8 h-8 flex items-center justify-center bg-neutral-800 rounded-full hover:bg-neutral-700 transition-colors" onClick={(e) => { e.stopPropagation(); window.open(video.url, '_blank'); }}>â–¶ï¸</div>
            </div>
          </div>
        </div>
      );
    }

    function App() {
      const [videos, setVideos] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [selectedCategory, setSelectedCategory] = useState("å…¨éƒ¨");
      const [selectedStatus, setSelectedStatus] = useState("å…¨éƒ¨");
      const [searchQuery, setSearchQuery] = useState("");
      const [selectedVideo, setSelectedVideo] = useState(null);

      useEffect(() => {
        fetch(API_URL)
          .then(res => res.json())
          .then(data => {
            const formattedVideos = data.map((item, index) => {
              const props = item.properties;
              return {
                id: item.id || index,
                title: props['å½±ç‰‡æ¨™é¡Œ']?.title?.[0]?.plain_text || 'ç„¡æ¨™é¡Œ',
                channel: props['é »é“']?.rich_text?.[0]?.plain_text || '',
                category: props['åˆ†é¡']?.select?.name || '',
                status: props['ç‹€æ…‹']?.select?.name || 'å¾…çœ‹',
                priority: props['å„ªå…ˆåº¦']?.select?.name || '',
                thumbnail: props['ç¸®åœ–ç¶²å€']?.url || '',
                url: props['ç¶²å€']?.url || '',
                summary: props['AI æ‘˜è¦']?.rich_text?.[0]?.plain_text || '',
                keyTakeaway: props['ä¸€å¥è©±å­¸åˆ°']?.rich_text?.[0]?.plain_text || '',
                highlights: props['ç²¾è¯ç‰‡æ®µ']?.rich_text?.[0]?.plain_text || '',
                rating: props['æˆ‘çš„è©•åˆ†']?.number || 0,
                createdTime: item.created_time || '',
              };
            });
            formattedVideos.sort((a, b) => new Date(b.createdTime) - new Date(a.createdTime));
            setVideos(formattedVideos);
            setLoading(false);
          })
          .catch(err => {
            setError('ç„¡æ³•è¼‰å…¥è³‡æ–™');
            setLoading(false);
          });
      }, []);

      const handleVideoUpdate = (videoId, updates) => {
        setVideos(prev => prev.map(v => v.id === videoId ? { ...v, ...updates } : v));
      };

      const handleVideoDelete = (videoId) => {
        setVideos(prev => prev.filter(v => v.id !== videoId));
      };

      const filteredVideos = useMemo(() => {
        return videos.filter(video => {
          const matchCategory = selectedCategory === "å…¨éƒ¨" || video.category === selectedCategory;
          const matchStatus = selectedStatus === "å…¨éƒ¨" || video.status === selectedStatus;
          const matchSearch = video.title.toLowerCase().includes(searchQuery.toLowerCase()) || video.channel.toLowerCase().includes(searchQuery.toLowerCase());
          return matchCategory && matchStatus && matchSearch;
        });
      }, [videos, selectedCategory, selectedStatus, searchQuery]);

      const stats = useMemo(() => ({
        total: videos.length,
        pending: videos.filter(v => v.status === "å¾…çœ‹").length,
        inProgress: videos.filter(v => v.status === "é€²è¡Œä¸­").length,
        completed: videos.filter(v => v.status === "å·²å®Œæˆ").length,
        summarized: videos.filter(v => v.summary).length,
      }), [videos]);

      const getThumbnail = (video) => {
        if (video.thumbnail) return video.thumbnail;
        if (video.url) {
          const match = video.url.match(/[?&]v=([^&]+)/);
          if (match) return `https://i.ytimg.com/vi/${match[1]}/hqdefault.jpg`;
        }
        return '';
      };

      if (loading) {
        return (
          <div className="min-h-screen bg-neutral-950 text-neutral-200 flex items-center justify-center">
            <div className="text-center">
              <div className="animate-spin w-8 h-8 border-2 border-white border-t-transparent rounded-full mx-auto mb-4"></div>
              <p>è¼‰å…¥ä¸­...</p>
            </div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="min-h-screen bg-neutral-950 text-neutral-200 flex items-center justify-center">
            <div className="text-center">
              <p className="text-red-400 mb-4">{error}</p>
              <button onClick={() => window.location.reload()} className="px-4 py-2 bg-white text-black rounded-lg">é‡æ–°è¼‰å…¥</button>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-neutral-950 text-neutral-200">
          <header className="sticky top-0 z-40 border-b border-neutral-800 bg-neutral-950/90 backdrop-blur-md">
            <div className="max-w-6xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div>
                  <h1 className="text-xl font-semibold text-white">ğŸ“š Ray çš„å­¸ç¿’ç ”ç©¶åº«</h1>
                  <p className="text-neutral-500 text-sm mt-0.5">æŠŠè³‡è¨Šç„¦æ…®è½‰åŒ–ç‚ºç³»çµ±å­¸ç¿’</p>
                </div>
                <div className="flex gap-2">
                  <button onClick={() => window.location.reload()} className="bg-neutral-800 text-white font-medium px-4 py-2 rounded-lg text-sm hover:bg-neutral-700 transition-colors">ğŸ”„ åˆ·æ–°</button>
                  <a href="https://www.notion.so/76fb8600ae9649bcb6c475f75f0ec818" target="_blank" rel="noopener noreferrer" className="bg-white text-black font-medium px-4 py-2 rounded-lg text-sm hover:bg-neutral-200 transition-colors hidden sm:block">Notion â†’</a>
                </div>
              </div>
              <div className="flex gap-4 sm:gap-6 text-sm overflow-x-auto pb-2">
                <span className="text-neutral-400 whitespace-nowrap">ç¸½å…± <span className="text-white font-medium">{stats.total}</span></span>
                <span className="text-neutral-400 whitespace-nowrap">å¾…çœ‹ <span className="text-white font-medium">{stats.pending}</span></span>
                <span className="text-neutral-400 whitespace-nowrap">é€²è¡Œä¸­ <span className="text-white font-medium">{stats.inProgress}</span></span>
                <span className="text-neutral-400 whitespace-nowrap">å·²å®Œæˆ <span className="text-white font-medium">{stats.completed}</span></span>
                <span className="text-neutral-400 whitespace-nowrap">å·²æ•´ç† <span className="text-white font-medium">{stats.summarized}</span></span>
              </div>
            </div>
          </header>

          <main className="max-w-6xl mx-auto px-4 py-4">
            <div className="flex flex-col sm:flex-row gap-3 mb-6">
              <input type="text" placeholder="æœå°‹..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="w-full sm:w-48 px-4 py-2 rounded-lg border border-neutral-800 bg-neutral-900 text-neutral-200 text-sm outline-none focus:border-neutral-600 transition-colors placeholder-neutral-600" />
              <div className="flex gap-1 overflow-x-auto pb-2 sm:pb-0">
                {categories.map(cat => (
                  <button key={cat} onClick={() => setSelectedCategory(cat)} className={`px-3 py-1.5 rounded-md text-sm whitespace-nowrap transition-colors ${selectedCategory === cat ? 'bg-white text-black font-medium' : 'text-neutral-400 hover:text-white'}`}>{cat}</button>
                ))}
              </div>
              <div className="hidden sm:block h-4 w-px bg-neutral-800 self-center"></div>
              <div className="flex gap-1 overflow-x-auto pb-2 sm:pb-0">
                {statuses.map(status => (
                  <button key={status} onClick={() => setSelectedStatus(status)} className={`px-3 py-1.5 rounded-md text-sm whitespace-nowrap transition-colors ${selectedStatus === status ? 'bg-neutral-800 text-white font-medium' : 'text-neutral-400 hover:text-white'}`}>{status}</button>
                ))}
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {filteredVideos.map(video => (
                <VideoCard key={video.id} video={video} getThumbnail={getThumbnail} onOpenModal={setSelectedVideo} />
              ))}
            </div>

            {filteredVideos.length === 0 && <div className="text-center py-16"><p className="text-neutral-500">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å½±ç‰‡</p></div>}
          </main>

          <a href="https://t.me/YT_video_DB_bot" target="_blank" rel="noopener noreferrer" className="fixed bottom-6 right-6 bg-neutral-800 hover:bg-neutral-700 rounded-full px-4 py-2 flex items-center gap-2 transition-colors border border-neutral-700">
            <span>âœˆï¸</span>
            <span className="text-sm text-neutral-300">æ–°å¢å½±ç‰‡</span>
          </a>

          {selectedVideo && (
            <VideoModal video={selectedVideo} onClose={() => setSelectedVideo(null)} onUpdate={handleVideoUpdate} onDelete={handleVideoDelete} />
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
